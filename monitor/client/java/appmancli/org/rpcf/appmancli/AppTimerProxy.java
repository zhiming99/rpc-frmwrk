// GENERATED BY RIDLC, MAKE SURE TO BACKUP BEFORE RUNNING RIDLC AGAIN
// Copyright (C) 2025  zhiming <woodhead99@gmail.com>
// This program can be distributed under the terms of the GNU GPLv3.
package org.rpcf.appmancli;
import java.util.Map;
import java.util.HashMap;
import java.lang.String;

import org.rpcf.rpcbase.*;

import java.util.concurrent.Callable;

import org.rpcf.rpcbase.JavaReqContext;
import org.rpcf.rpcbase.ObjPtr;
import org.rpcf.rpcbase.rpcbase;

public class AppTimerProxy extends AppManagercli
{
    public AppTimerProxy( ObjPtr pIoMgr,
                          String strDesc, String strSvrObj )
    { super( pIoMgr, strDesc, strSvrObj ); }

    public int m_iInterval = 10;

    public void OnPointChanged(
        JavaReqContext oReqCtx,
        String strPtPath,
        JVariant value  )
    {
        String[] parts = strPtPath.split("/");
        if (parts.length != 2) return;

        String appName = parts[0];
        String pointName = parts[1];

        if (!appName.equals(this.m_strAppInst)) return;

        if (pointName.equals("interval1") ) {
            setInterval( ( Integer )value.val );
            return;
        }
        super.OnPointChanged( oReqCtx, strPtPath, value);
    }

    public synchronized void setInterval( int i )
    { m_iInterval = i; }

    public synchronized int getInterval()
    { return m_iInterval; }

    public static JavaRpcContext m_oCtx;
    public static void main(String[] args )
    {
        int ret = 0;
        // prepare the init parameters for iomgr
        Map< Integer, Object > oInit =
                new HashMap< Integer, Object >();
        oInit.put( 0, "appmoncli" );
        String strCfgPath = "invalidpath/driver.json";
        if( strCfgPath.length() > 0 )
            oInit.put( 105, strCfgPath );
        m_oCtx = JavaRpcContext.createProxy( oInit );
        if( m_oCtx == null )
        { ret = RC.EFAULT; return; };

        try{
            Callable<AppManagercli> oCreateFunc =
                ()->new AppTimerProxy(m_oCtx.getIoMgr(),
                "invalidpath/appmondesc.json",
                "AppManager");
            ret = MainThread.startAppManagercli(
                null, m_oCtx, "timer1",
                oCreateFunc, true );
            if( RC.ERROR( ret ) )
                return;
            ret = timerLoop();
        } catch ( Exception e ) {
            e.printStackTrace();
        }
        finally
        {
            MainThread.stopAppManagercli();
            rpcbase.JavaOutputMsg(
                    "Quit with status: " + ret);
            if( m_oCtx != null )
                m_oCtx.stop();
            System.exit( -ret );
        }
    }
    public static AppManagercli waitConnected()
    {
        AppManagercli oProxy = null;
        do {
            oProxy = MainThread.getAppmangercli();
            if( oProxy != null )
                break;
            MainThread.WaitSeconds(1);
            if( MainThread.isExit() )
                return null;
        }while (oProxy == null);
        return oProxy;
    }
    // ------customize this method for your own purpose----
    public static int timerLoop()
    {
        AppTimerProxy oTimer = ( AppTimerProxy ) waitConnected();
        JRetVal jRetVal = oTimer.GetPointValue("timer1/interval1");
        if( jRetVal.SUCCEEDED()) {
            JVariant oVar = (JVariant) jRetVal.getAt(0);
            oTimer.setInterval( ( Integer )oVar.val );
            rpcbase.JavaOutputMsg("Info interval changed to " + oVar.val );
        }

        int iTicks =0;
        while( !MainThread.isExit() )
        {
            MainThread.WaitSeconds(1);
            iTicks += 1;
            if( iTicks % oTimer.getInterval() > 0 )
                continue;
            JVariant oVar = new JVariant();
            oVar.iType = rpcbaseConstants.typeUInt32;
            oVar.val = ( Integer )1;
            MainThread.addTask(oProxy1 -> oProxy1.SetPointValue("timer1/clock1", oVar));
            rpcbase.JavaOutputMsg("Info send clock1 " + iTicks );
            waitConnected();
        }
        return RC.STATUS_SUCCESS;
    }
}
