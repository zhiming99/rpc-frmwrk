<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RPC-Framework Monitor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    #status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
    @media (max-width: 600px) {
      .card { margin-bottom: 1rem; }
      #config-btn { width: 100%; }
    }
    #logs-panel {
        height: 100dvh;
        white-space: pre-wrap;       /* Since CSS 2.1 */
        white-space: -moz-pre-wrap;  /* Mozilla, since 1999 */
        white-space: -pre-wrap;      /* Opera 4-6 */
        white-space: -o-pre-wrap;    /* Opera 7 */
        word-wrap: break-word;       /* Internet Explorer 5.5+ */
        max-height: 600px;
    }
    .card.text-center:hover {
      box-shadow: 0 0 10px 2px #0d6efd33; /* subtle blue shadow */
      background-color: #c1c4c7;           /* light blue background */
      transition: box-shadow 0.2s, background-color 0.2s;
      cursor: pointer;
    }
  </style>
</head>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <span id="status-dot" class="bg-success"></span>
      <span class="navbar-brand mb-0 h1" id="APP_TITLE">RPC-Framework Monitor</span>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <!--<button id="config-btn" class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#configModal">Update Config</button>-->
            <button id="reconnect-btn" class="btn btn-warning btn-sm ms-2 d-none">Login</button>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container my-3">
    <div class="row" id="sites-row">
      <!-- sites cards -->
      <!-- Add more cards as needed -->
    </div>

    <div class="row" id="logs-row" style="display:none;">
      <div class="col-12">
        <div class="card mb-3">
          <div class="card-header" id="LogsTitle">Logs</div>
          <div class="card-body" style="overflow-y:auto;">
            <pre id="logs-panel" class="mb-0">Loading logs...</pre>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Setpoints Modal -->
  <div class="modal fade" id="setpointsModal" tabindex="-1" aria-labelledby="setpointsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="setpointsModalLabel">Setpoints</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <h6 id="setpointsAppName" class="mb-3"></h6>
          <table class="table">
            <thead>
              <tr>
                <th scope="col" id="setpoint-name-header">Name</th>
                <th scope="col" id="setpoint-value-header">Value</th>
              </tr>
            </thead>
            <tbody id="setpointsTableBody">
              <tr>
                <td colspan="2">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="./i18n-helper.js"></script>
  <script>
    const i18nh = globalThis.i18nHelper; // Make it globally accessible
    i18nh.load(navigator.language).then(() => {
      console.log("Translations loaded");
      document.getElementById('reconnect-btn').textContent = i18nh.t("Login");
      document.getElementById('APP_TITLE').textContent = i18nh.t("APP_TITLE");
      document.getElementById('logs-panel').textContent = i18nh.t("Loading logs...");
      document.getElementById('LogsTitle').textContent = i18nh.t("LOGS");
    }).catch((error) => {
      console.error("Error loading translations:", error);
    });
  </script>

  <script>
    function setStatusDot(isOnline) {
      const dot = document.getElementById('status-dot');
      dot.classList.remove('bg-success', 'bg-danger');
      if (isOnline === true) {
        dot.classList.add('bg-success');
      } else if (isOnline === false) {
        dot.classList.add('bg-danger');
      }
    }

    function showReconnectButton(show, isConnected = false) {
      const btn = document.getElementById('reconnect-btn');
      if (show) {
        btn.classList.remove('d-none');
        if (isConnected) {
          btn.textContent = i18nh.t('Logout');
          btn.classList.remove('btn-warning');
          btn.classList.add('btn-danger');
          btn.onclick = function() {
            // Your disconnect logic here
            if (globalThis.oProxy && typeof globalThis.oProxy.Stop === 'function') {
              globalThis.oProxy.Stop();
            } else {
              // fallback: reload or nullify
              location.reload();
            }
          };
        } else {
          btn.textContent = i18nh.t('Login');
          btn.classList.remove('btn-danger');
          btn.classList.add('btn-warning');
          btn.onclick = function() {
            // Your reconnect logic here
            if (typeof globalThis.StartClient === 'function') {
              globalThis.StartClient( oStartCb ).then(() => {
                console.log('Reconnected with status ');
                checkProxyState()
              }).catch((error) => {
                console.log("Error reconnecting:", error);
              });
            } else {
              location.reload();
            }
          };
        }
      } else {
        btn.classList.add('d-none');
      }
    }

    setStatusDot(false);
    showReconnectButton(true);

    const sites = [
      {
        name: "site1",
        container: "container1",
        status: "online",
        apps: [
          /*{ name: "AppA", status: "Running", cpu: "10%" },
          { name: "AppB", status: "Stopped", cpu: "0%" } */
        ]
      },
      /*{
        name: "site2",
        status: "offline",
        container: "container2",
        apps: [
          { name: "AppC", status: "Running", cpu: "7%" }
        ]
      }*/
    ];
    globalThis.g_sites = sites;
    function updateSites(sites) {
        if( globalThis.curSpModal )
        {
            updateAppDetailModal( globalThis.curSpModal.currentApp,
                globalThis.curSpModal.currentSite );
        }
        if( !globalThis.curSpModal || !globalThis.oProxy || globalThis.oProxy.m_iState === 0 )
        {
            const sitesRow = document.getElementById('sites-row');
            var siteCard = null;
            sites.forEach(site => {
              appRow = document.getElementById(`app-row-${site.name}`);
              if( appRow.children.length !== site.apps.length )
              {
                  renderSites(sites);
                  return;
              }
            })
            sites.forEach(site => {
              for( const app of site.apps ) {
                  appStatus = document.getElementById(`app-status-${app.name}-${site.name}`)
                  if( appStatus )
                  {
                      let statusClass = '';
                      if (app.status === i18nHelper.t("APP_STATUS_RUNNING")) {
                            statusClass = 'bg-success text-white px-2 rounded';
                      } else if (app.status === i18nHelper.t("APP_STATUS_STOPPED")) {
                            statusClass = 'bg-danger text-white px-2 rounded';
                      } else if (app.status === i18nHelper.t("APP_STATUS_UNKNOWN")) {
                            statusClass = 'bg-secondary text-white px-2 rounded';
                      }
                      appStatus.innerHTML = `<b>${i18nHelper.t("STATUS")}:</b> <span class="${statusClass}">${app.status}</span><br><b>${i18nHelper.t("CPU_USAGE")}:</b> ${app.cpu}`;
                  }
              }
            })
        }
    }

    function renderSites(sites) {
        const sitesRow = document.getElementById('sites-row');
        sitesRow.innerHTML = ''; // Clear previous content

        sites.forEach(site => {
            // Create site card
            const siteCol = document.createElement('div');
            siteCol.className = 'col-12 mb-4';

            const siteCard = document.createElement('div');
            siteCard.className = 'card';

            const siteHeader = document.createElement('div');
            siteHeader.className = 'card-header bg-info text-white';
            siteHeader.textContent = `${i18nHelper.t("SITE_LABEL")}: ${site.name} (${i18nHelper.t("CONTAINER_LABEL")}: ${site.container})`;

            const siteBody = document.createElement('div');
            siteBody.className = 'card-body';

            const appRow = document.createElement('div');
            appRow.className = 'row';
            appRow.id = `app-row-${site.name}`;

            site.apps.forEach(app => {
                const appCol = document.createElement('div');
                appCol.className = 'col-12 col-md-6 col-lg-3 mb-3';

                const appCard = document.createElement('div');
                appCard.className = 'card text-center';
                appCard.style.cursor = 'pointer';
                appCard.onclick = function() {
                    if( !globalThis.curSpModal && globalThis.oProxy )
                        showAppDetailModal(app, site);
                }

                const appCardBody = document.createElement('div');
                appCardBody.className = 'card-body';

                const appTitle = document.createElement('h5');
                appTitle.className = 'card-title';
                appTitle.textContent = app.name;

                const appStatus = document.createElement('p');
                appStatus.className = 'card-text';
                appStatus.id = `app-status-${app.name}-${site.name}`;

                let statusClass = '';
                if (app.status === i18nHelper.t("APP_STATUS_RUNNING")) {
                    statusClass = 'bg-success text-white px-2 rounded';
                } else if (app.status === i18nHelper.t("APP_STATUS_STOPPED")) {
                    statusClass = 'bg-danger text-white px-2 rounded';
                } else if (app.status === i18nHelper.t("APP_STATUS_UNKNOWN")) {
                    statusClass = 'bg-secondary text-white px-2 rounded';
                }
                appStatus.innerHTML = `<b>${i18nHelper.t("STATUS")}:</b> \
                    <span class="${statusClass}">${app.status}</span><br> \
                    <b>${i18nHelper.t("CPU_USAGE")}:</b> ${app.cpu}`;

                appCardBody.appendChild(appTitle);
                appCardBody.appendChild(appStatus);
                appCard.appendChild(appCardBody);
                appCol.appendChild(appCard);
                appRow.appendChild(appCol);
            });

            siteBody.appendChild(appRow);
            siteCard.appendChild(siteHeader);
            siteCard.appendChild(siteBody);
            siteCol.appendChild(siteCard);
            sitesRow.appendChild(siteCol);
        });
    }

    // Example usage:
  </script>

  <footer class="text-center text-muted py-3">
    rpc-frmwrk &copy; 2025
  </footer>
  <!--p id="log">RPC-Framework Monitor<br /></p>-->
  <script src="dist/appmon.js"></script>
  <p id="rpcf_load_notify"><br /></p>
  <script>
    globalThis.g_bAuth = false
    globalThis.g_strAuthMech = ""

    var iChecks = 0;
    function DoCleanup()
    {
        setStatusDot(false);
        showReconnectButton(true, false);
        clearLogs();
        if( g_sites && g_sites.length > 0 )
        {
            g_sites.forEach(site => {
                site.apps.forEach(app => {
                    app.status = i18nHelper.t("APP_STATUS_UNKNOWN");
                    app.cpu = "N/A";
                });
            });
            updateSites(globalThis.g_sites);
        }
        globalThis.oProxy = null;
        if( globalThis.curSpModal )
        {
            globalThis.curSpModal.hide();
            globalThis.curSpModal = undefined;
        }
        const logsRow = document.getElementById('logs-row');
        logsRow.style.display = "none"

        iChecks = 0;
    }

    setStatusDot(false);
    showReconnectButton(true, false);

    function checkProxyState(){
        if( globalThis.oProxy === undefined ){
            setTimeout( checkProxyState, 2000 );
            console.log( "Waiting RPC connection ready..." );
        }else if( globalThis.oProxy === null ){
            console.log( "RPC connection is shutdown abnormally..." );
            DoCleanup();
        }else if( globalThis.oProxy.m_iState === 0 ){
            console.log( "RPC connection is down..." );
            DoCleanup();
        }else{
            if( iChecks++ === 0 )
            {
                //fetchLogs();
                console.log( "RPC connection ready " + globalThis.oProxy );
            }
            setTimeout( checkProxyState, 5000 );
        }
    }
    setTimeout( checkProxyState, 2000 );
    //# sourceURL=rpcf://htmlcode/checkstate.js
  </script>
  <script src="./appdetail.js"></script>
  <script>
    // Example: Simulate data fetching
    function clearLogs()
    { document.getElementById('logs-panel').textContent = ""; }

    function fetchStatus() {
      if( !globalThis.oProxy)
      {
          clearInterval(globalThis.fetchStatusInterval);
          globalThis.fetchStatusInterval = undefined;
          return Promise.resolve(0);
      }

      if( globalThis.funcStartPullInfo ){
          console.log( "Start pulling info..." );
          return globalThis.funcStartPullInfo().then((ret) => {
              updateSites(globalThis.g_sites);
          }).catch((error) => {
              console.log("Error fetching status:", error);
          });
        }
        return Promise.resolve(0);
    }
    function fetchLogs() {
      if( !globalThis.oProxy)
      {
          clearInterval(globalThis.fetchLogsInterval);
          globalThis.fetchLogsInterval = undefined;
          return Promise.resolve(0);
      }
      var oContext = Object()
      oContext.oGetLpvCb = (oContext, ret, value) => {
          const logsRow = document.getElementById('logs-row');
          if (ret === 0) {
              logsRow.style.display = ""
              const decoder = new TextDecoder('utf-8')
              let text=decoder.decode(value);
              lineArray = text.split('\n').reverse();
              const regex = /^\[(\d+\.\d+)/;
              for(let i = 0; i < lineArray.length; i++) {
                  const match = lineArray[i].match(regex);
                  if (match) {
                      const timestamp = parseFloat(match[1]);
                      const date = new Date(timestamp * 1000);
                      let formattedDate = date.toLocaleString(
                            navigator.language,
                            { 
                              year: 'numeric',
                              month: '2-digit',
                              day: '2-digit',
                              hour: '2-digit',
                              minute: '2-digit',
                              second: '2-digit',
                              hour12: false, // Ensures 24-hour format
                            });
                      formattedDate = formattedDate.replace(/, /, '-');
                      lineArray[i] = lineArray[i].replace(regex, `[${formattedDate}`);
                  }
              }
              document.getElementById('logs-panel').innerHTML =
                lineArray.join('\n').trim();
          } else {
              logsRow.style.display = "none"
              console.log("Error fetching logs:", ret);
          }
      };
      return globalThis.oProxy.GetLargePointValue(
          oContext, "loggersvr1/logcontent").then((ret) => {
          Promise.resolve(ret); 
      }).catch((error) => {
          console.log("Error fetching logs:", error);
      });
    }

    function updateAppDetailModal(app, site) {
        // Set modal title
        document.getElementById('setpointsModalLabel').textContent = i18nHelper.t("Setpoints");
        document.getElementById('setpointsAppName').textContent = `${i18nHelper.t("APP")}: ${app.name} (${i18nHelper.t("SITE_LABEL")}: ${site.name})`;

        const setpoints = app.setpoints 
        const tbody = document.getElementById('setpointsTableBody');
        tbody.innerHTML = '';
        if (setpoints.size === 0) {
            tbody.innerHTML = `<tr><td colspan="2">${i18nHelper.t("NO_DATA")}</td></tr>`;
        } else {
            const arrPts = globalThis.curSpModal.arrPts;
            for( elem in arrPts )
            {
                if( !setpoints.has(arrPts[elem].n) )
                    continue
                value = setpoints.get(arrPts[elem].n);
                if( value === undefined )
                    continue
                const tr = document.createElement('tr');
                var valToShow = value.v;
                if( value.t === "float" || value.t === "double" )
                    valToShow = valToShow.toFixed(3);
                if( value.cnt > 0 )
                {
                    valColor = "text-danger";
                    value.cnt--;
                }
                else
                    valColor = "text-secondary";
                valToShow = `<span class="${valColor}">${valToShow}</span>`;
                tr.innerHTML = `<td>${i18nHelper.t(arrPts[elem].n)}</td><td>${valToShow}</td>`;
                tbody.appendChild(tr);
            }
        }
    }
    function showAppDetailModal(app, site) {
        // Set modal title
        document.getElementById('setpointsModalLabel').textContent = i18nHelper.t("Setpoints");
        document.getElementById('setpointsAppName').textContent = `${i18nHelper.t("APP")}: ${app.name} (${i18nHelper.t("SITE_LABEL")}: ${site.name})`;

        // Example: app.setpoints = [{name: "SP1", value:{ v:123, t:"i" }, ...}]
        const setpoints = app.setpoints || new Map();
        const tbody = document.getElementById('setpointsTableBody');
        tbody.innerHTML = '';
        if (setpoints.size === 0) {
            tbody.innerHTML = `<tr><td colspan="2">${i18nHelper.t("NO_DATA")}</td></tr>`;
        } else {
            setpoints.forEach((value, key) => {
                const tr = document.createElement('tr');
                var valToShow = value.v;
                if( value.t === "float" || value.t === "double" )
                    valToShow = valToShow.toFixed(3);
                tr.innerHTML = `<td>${i18nHelper.t(key)}</td><td>${valToShow}</td>`;
                tbody.appendChild(tr);
            });
        }

        // Show the modal
        var modalEl = document.getElementById('setpointsModal');
        var modal = new bootstrap.Modal(modalEl);
        globalThis.curSpModal = modal;
        modal.currentSite = site;
        modal.currentApp = app;

        globalThis.OnPointChanged = (strPtPath, value) => {
            if (modal.currentApp && modal.currentApp.setpoints) {
                var arrComps = strPtPath.split('/')
                if( arrComps.length < 2 )
                    return
                attr = modal.currentApp.setpoints.get(arrComps[1])
                if (!attr)
                    attr = { v: null, t: null };
                attr.v = value.m_val
                attr.t = type2str(value.m_iType)
                attr.cnt = (attr.cnt?attr.cnt:0) + 1;
                modal.currentApp.setpoints.set(arrComps[1], attr);
            }
        };
        modalEl.addEventListener('hidden.bs.modal', function (event) {
            document.getElementById('setpointsTableBody').innerHTML = '';
            if( globalThis.curSpModal && globalThis.oProxy)
            {
                return globalThis.oProxy.RemoveListener( Object() ).then((ret)=>{
                    var modal = globalThis.curSpModal;
                    if ( !modal )
                        return;
                    modal.currentApp.bRegistered = false;
                    if( modal.currentApp )
                        modal.currentApp.setpoints = new Map();
                    console.log("Listener removed:", ret);
                    globalThis.curSpModal = null;
                    // globalThis.fetchStatusInterval =
                    //     setInterval(fetchStatus, 5000);
                    globalThis.fetchLogsInterval =
                        setInterval(fetchLogs, 30000);
                }).catch((error)=>{
                    var modal = globalThis.curSpModal;
                    if ( !modal )
                        return;
                    modal.currentApp.bRegistered = false;
                    if( modal.currentApp )
                        modal.currentApp.setpoints = new Map();
                    console.log("Error removing listener:", error);
                    globalThis.curSpModal = null;
                    // globalThis.fetchStatusInterval =
                    //     setInterval(fetchStatus, 5000);
                    globalThis.fetchLogsInterval =
                        setInterval(fetchLogs, 30000);
                });
                modalEl.removeEventListener('hidden.bs.modal', this);
            }
        });

        document.getElementById('setpoint-name-header').textContent = i18nHelper.t("Name");
        document.getElementById('setpoint-value-header').textContent = i18nHelper.t("Value");
        modal.show();
        // clearInterval(globalThis.fetchStatusInterval);
        // globalThis.fetchStatusInterval = undefined;
        clearInterval(globalThis.fetchLogsInterval);
        globalThis.fetchLogsInterval = undefined;
        fetchStatus();
    }

    var oStartCb = ((context, ret)=>{
      setStatusDot(true);
      showReconnectButton(true, true);
      renderSites(globalThis.g_sites);
      return fetchStatus().then((ret)=>{
          return fetchLogs().then((ret)=>{
              globalThis.fetchStatusInterval =
                  setInterval(fetchStatus, 5000);
              globalThis.fetchLogsInterval =
                  setInterval(fetchLogs, 30000);
          })
      })
    })
    globalThis.StartClient( oStartCb)

  </script>
</body>
</html>
