<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RPC-Framework Monitor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    #status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
    @media (max-width: 600px) {
      .card { margin-bottom: 1rem; }
      #config-btn { width: 100%; }
    }
    #logs-panel {
        max-height: 200px;
        white-space: pre-wrap;       /* Since CSS 2.1 */
        white-space: -moz-pre-wrap;  /* Mozilla, since 1999 */
        white-space: -pre-wrap;      /* Opera 4-6 */
        white-space: -o-pre-wrap;    /* Opera 7 */
        word-wrap: break-word;       /* Internet Explorer 5.5+ */
    }
  </style>
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <span id="status-dot" class="bg-success"></span>
      <span class="navbar-brand mb-0 h1">RPC-Framework Monitor</span>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <button id="config-btn" class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#configModal">Update Config</button>
            <button id="reconnect-btn" class="btn btn-warning btn-sm ms-2 d-none">Connect</button>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container my-3">
    <div class="row" id="sites-row">
      <!-- sites cards -->
      <!-- Add more cards as needed -->
    </div>

    <div class="row">
      <div class="col-12">
        <div class="card mb-3">
          <div class="card-header">Logs</div>
          <div class="card-body" style="max-height:200px; overflow-y:auto;">
            <pre id="logs-panel" class="mb-0">Loading logs...</pre>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Config Modal -->
  <div class="modal fade" id="configModal" tabindex="-1" aria-labelledby="configModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" id="config-form">
        <div class="modal-header">
          <h5 class="modal-title" id="configModalLabel">Update Configuration</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="config-param" class="form-label">Parameter</label>
            <input type="text" class="form-control" id="config-param" required>
          </div>
          <div class="mb-3">
            <label for="config-value" class="form-label">Value</label>
            <input type="text" class="form-control" id="config-value" required>
          </div>
          <div id="config-feedback" class="text-danger small"></div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Update</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>

    function setStatusDot(isOnline) {
      const dot = document.getElementById('status-dot');
      dot.classList.remove('bg-success', 'bg-danger');
      if (isOnline === true) {
        dot.classList.add('bg-success');
      } else if (isOnline === false) {
        dot.classList.add('bg-danger');
      }
    }

    function showReconnectButton(show, isConnected = false) {
      const btn = document.getElementById('reconnect-btn');
      if (show) {
        btn.classList.remove('d-none');
        if (isConnected) {
          btn.textContent = 'Disconnect';
          btn.classList.remove('btn-warning');
          btn.classList.add('btn-danger');
          btn.onclick = function() {
            // Your disconnect logic here
            if (globalThis.oProxy && typeof globalThis.oProxy.Stop === 'function') {
              globalThis.oProxy.Stop();
            } else {
              // fallback: reload or nullify
              // globalThis.oProxy = null;
              location.reload();
            }
          };
        } else {
          btn.textContent = 'Connect';
          btn.classList.remove('btn-danger');
          btn.classList.add('btn-warning');
          btn.onclick = function() {
            // Your reconnect logic here
            if (typeof globalThis.StartClient === 'function') {
              globalThis.StartClient().then(() => {
                console.log('Reconnected with status ');
                checkProxyState()
              }).catch((error) => {
                console.log("Error reconnecting:", error);
              });
            } else {
              location.reload();
            }
          };
        }
      } else {
        btn.classList.add('d-none');
      }
    }
    setStatusDot(false);
    showReconnectButton(true);

    const sites = [
      {
        name: "site1",
        container: "container1",
        status: "online",
        apps: [
          /*{ name: "AppA", status: "Running", cpu: "10%" },
          { name: "AppB", status: "Stopped", cpu: "0%" } */
        ]
      },
      /*{
        name: "site2",
        status: "offline",
        container: "container2",
        apps: [
          { name: "AppC", status: "Running", cpu: "7%" }
        ]
      }*/
    ];
    globalThis.g_sites = sites;
    function updateSites(sites) {
      const sitesRow = document.getElementById('sites-row');

      var siteCard = null;
      sites.forEach(site => {
        // find site card
        for (const child of sitesRow.children) {
          if (child.querySelector('.card-header').textContent === `Site: ${site.name} (Container: ${site.container})`) {
            // Site card already exists, no need to create a new one
            siteCard = child;
            break;
          }
        }

        if( !siteCard )
            return;

        var appCols = siteCard.children[0].children[1].children[0].children
        for( const child of appCols ) {
            for( const app of site.apps ) {
              if( child.querySelector('.card-title').textContent === app.name ) {
                // App card already exists, no need to create a new one
                appText = child.querySelector('.card-text');
                appText.innerHTML = `<b>Status:</b> ${app.status}<br><b>CPU:</b> ${app.cpu}`;
                break;
              }
            }
        }
      });
    }

    function renderSites(sites) {
      const sitesRow = document.getElementById('sites-row');
      sitesRow.innerHTML = ''; // Clear previous content

      sites.forEach(site => {
        // Create site card
        const siteCol = document.createElement('div');
        siteCol.className = 'col-12 mb-4';

        const siteCard = document.createElement('div');
        siteCard.className = 'card';

        const siteHeader = document.createElement('div');
        siteHeader.className = 'card-header bg-info text-white';
        siteHeader.textContent = `Site: ${site.name} (Container: ${site.container})`;

        const siteBody = document.createElement('div');
        siteBody.className = 'card-body';

        const appRow = document.createElement('div');
        appRow.className = 'row';

        site.apps.forEach(app => {
          const appCol = document.createElement('div');
          appCol.className = 'col-12 col-md-6 col-lg-3 mb-3';

          const appCard = document.createElement('div');
          appCard.className = 'card text-center';

          const appCardBody = document.createElement('div');
          appCardBody.className = 'card-body';

          const appTitle = document.createElement('h5');
          appTitle.className = 'card-title';
          appTitle.textContent = app.name;

          const appStatus = document.createElement('p');
          appStatus.className = 'card-text';
          appStatus.innerHTML = `<b>Status:</b> ${app.status}<br><b>CPU:</b> ${app.cpu}`;

          appCardBody.appendChild(appTitle);
          appCardBody.appendChild(appStatus);
          appCard.appendChild(appCardBody);
          appCol.appendChild(appCard);
          appRow.appendChild(appCol);
        });

        siteBody.appendChild(appRow);
        siteCard.appendChild(siteHeader);
        siteCard.appendChild(siteBody);
        siteCol.appendChild(siteCard);
        sitesRow.appendChild(siteCol);
      });
    }

    // Example usage:
  </script>

  <footer class="text-center text-muted py-3">
    rpc-frmwrk &copy; 2025
  </footer>
  <!--p id="log">RPC-Framework Monitor<br /></p>-->
  <script src="dist/appmon.js"></script>
  <p id="rpcf_load_notify"><br /></p>
  <script>
    globalThis.g_bAuth = false
    globalThis.g_strAuthMech = ""

    var iChecks = 0;
    function checkProxyState(){
        if( globalThis.oProxy === undefined ){
            setStatusDot(false);
            showReconnectButton(true, false);
            setTimeout( checkProxyState, 2000 );
            console.log( "Waiting RPC connection ready..." );
        }else if( globalThis.oProxy === null ){
            setStatusDot(false);
            showReconnectButton(true, false);
            console.log( "RPC connection is shutdown abnormally..." );
        }else if( globalThis.oProxy.m_iState === 0 ){
            setStatusDot(false);
            showReconnectButton(true, false);
            console.log( "RPC connection is down..." );
            clearLogs();
            globalThis.oProxy = null;
            iChecks = 0;
        }else{
            setStatusDot(true);
            showReconnectButton(true, true);
            if( iChecks++ === 0 )
            {
                renderSites(globalThis.g_sites);
                fetchLogs();
                globalThis.fetchStatusInterval =
                    setInterval(fetchStatus, 5000);
                globalThis.fetchLogsInterval =
                    setInterval(fetchLogs, 30000);
                console.log( "RPC connection ready " + globalThis.oProxy );
            }
            setTimeout( checkProxyState, 5000 );
        }
    }
    setTimeout( checkProxyState, 2000 );
    //# sourceURL=rpcf://htmlcode/checkstate.js
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Example: Simulate data fetching
    function clearLogs()
    { document.getElementById('logs-panel').textContent = ""; }

    function fetchStatus() {
      if( !globalThis.oProxy)
      {
         clearInterval(globalThis.fetchStatusInterval);
         return
      }

      if( globalThis.funcStartPullInfo ){
          console.log( "Start pulling info..." );
          globalThis.funcStartPullInfo().then((ret) => {
              updateSites(globalThis.g_sites);
          }).catch((error) => {
              console.log("Error fetching status:", error);
          });
        }
    }
    function fetchLogs() {
      if( !globalThis.oProxy)
      {
         clearInterval(globalThis.fetchLogsInterval);
         return
      }
      var oContext = Object()
      oContext.oGetLpvCb = (oContext, ret, value) => {
          if (ret === 0) {
              const decoder = new TextDecoder('utf-8')
              let text=decoder.decode(value);
              document.getElementById('logs-panel').innerHTML =
                text.split('\n').reverse().join('\n').trim();
          } else {
              console.log("Error fetching logs:", ret);
          }
      };
      return globalThis.oProxy.GetLargePointValue(
          oContext, "loggersvr1/logcontent").then((ret) => {
         Promise.resolve(ret); 
      }).catch((error) => {
          console.log("Error fetching logs:", error);
      });
    }

    // Config update handler
    document.getElementById('config-form').onsubmit = function(e) {
      e.preventDefault();
      const param = document.getElementById('config-param').value;
      const value = document.getElementById('config-value').value;
      // TODO: Replace with your JS API call to update config
      // Example:
      // oProxy.updateConfig(param, value).then(...);
      document.getElementById('config-feedback').textContent = 'Config updated (simulated)';
      setTimeout(() => {
        document.getElementById('config-feedback').textContent = '';
        bootstrap.Modal.getInstance(document.getElementById('configModal')).hide();
      }, 1000);
    };
  </script>
</body>
</html>
