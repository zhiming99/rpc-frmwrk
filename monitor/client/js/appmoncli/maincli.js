// GENERATED BY RIDLC, MAKE SURE TO BACKUP BEFORE RUNNING RIDLC AGAIN
// Copyright (C) 2025  zhiming <woodhead99@gmail.com>
// This program can be distributed under the terms of the GNU GPLv3.
// ../../../../ridl/.libs/ridlc --services=AppMonitor --odesc_url=https://192.168.1.3/rpcf -sJO . ../../../../monitor/appmon/appmon.ridl 
const { randomInt } = require( '/usr/local/lib/rpcf/jslib/combase/defines' );
const {CoCreateInstance, RegisterFactory}=require( '/usr/local/lib/rpcf/jslib/combase/factory' );
const {CIoManager} = require( '/usr/local/lib/rpcf/jslib/ipc/iomgr' );

// Start the iomanager
globalThis.g_iMsgIdx = randomInt( 0xffffffff );
globalThis.CoCreateInstance=CoCreateInstance;
globalThis.RegisterFactory=RegisterFactory;
globalThis.g_oIoMgr = new CIoManager();
globalThis.g_oIoMgr.Start()


const { CConfigDb2 } = require( '/usr/local/lib/rpcf/jslib/combase/configdb' );
const { messageType } = require( '/usr/local/lib/rpcf/jslib/dbusmsg/constants' );
const { ERROR, Int32Value, USER_METHOD } = require( '/usr/local/lib/rpcf/jslib/combase/defines' );
const {EnumClsid, errno, EnumPropId, EnumCallFlags, EnumTypeId, EnumSeriProto} = require( '/usr/local/lib/rpcf/jslib/combase/enums' );
const {CSerialBase, Variant} = require( '/usr/local/lib/rpcf/jslib/combase/seribase' );
const {CFastRpcProxy} = require( '/usr/local/lib/rpcf/jslib/ipc/fastrpc' )
const {Buffer} = require( 'buffer' );
const { DBusIfName, DBusDestination2, DBusObjPath } = require( '/usr/local/lib/rpcf/jslib/rpc/dmsg' );
const { KeyValue, } = require( './appmonstructs' );
// Start the client(s)
const { CAppMonitor_CliImpl } = require( './AppMonitorcli' )

var oProxy = null;
var strObjDesc = 'https://192.168.1.3/rpcf/appmondesc.json';
var strAppName = 'appmon';
var strAppMonitorObjName = 'AppMonitor';
var oParams0 = globalThis.CoCreateInstance( EnumClsid.CConfigDb2 );
oParams0.SetString( EnumPropId.propObjInstName, 'AppMonitor' );
var oAppMonitor_cli = new CAppMonitor_CliImpl( globalThis.g_oIoMgr,
    strObjDesc, strAppMonitorObjName, oParams0 );

 // start the client object
oAppMonitor_cli.Start().then((retval)=>{
    if( ERROR( retval ) )
    {
        globalThis.oProxy = null;
        return Promise.resolve( retval );
    }
    oProxy = oAppMonitor_cli;
    globalThis.oProxy = oProxy;

    return new Promise( ( resolve, reject )=>{
        var oContext = new Object();
        oContext.m_oResolve = resolve;
        oContext.m_oReject = reject;
        return oAppMonitor_cli.ListApps( oContext ).then((ret)=>{
            Promise.resolve( ret );
        }
        ).catch((e)=>{
            console.log( 'ListApps failed with error ' + e );
            Promise.reject( e );
        });
    }).then(( oContext)=>{
        console.log( 'request ListApps is done with status ' + oContext.m_iRet );
        appsAvail=[]

        for( var i = 0; i < globalThis.g_sites[0].apps.length; i++ )
            appsAvail.push( globalThis.g_sites[0].apps[i].name );

        return oAppMonitor_cli.IsAppOnline( oContext, appsAvail ).then((ret)=>{
            Promise.resolve( ret );
        }).catch((e)=>{
            console.log( 'IsAppOnline failed with error ' + e );
            Promise.reject( e );
        })
    }).catch((e)=>{
        console.log(e);
        return Promise.resolve(-errno.EFAULT);
    })
    
}).catch((e)=>{
    console.log( 'Start Proxy failed ' + e );
    return Promise.resolve(e);
})

