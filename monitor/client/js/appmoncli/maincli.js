// GENERATED BY RIDLC, MAKE SURE TO BACKUP BEFORE RUNNING RIDLC AGAIN
// Copyright (C) 2025  zhiming <woodhead99@gmail.com>
// This program can be distributed under the terms of the GNU GPLv3.
// ../../../../ridl/.libs/ridlc --services=AppMonitor -sJO . ../../../../monitor/appmon/appmon.ridl 
const { randomInt } = require( '/usr/local/lib/rpcf/jslib/combase/defines' );
const {CoCreateInstance, RegisterFactory}=require( '/usr/local/lib/rpcf/jslib/combase/factory' );
const {CIoManager} = require( '/usr/local/lib/rpcf/jslib/ipc/iomgr' );

// Start the iomanager
globalThis.g_iMsgIdx = randomInt( 0xffffffff );
globalThis.CoCreateInstance=CoCreateInstance;
globalThis.RegisterFactory=RegisterFactory;
globalThis.g_oIoMgr = new CIoManager();
globalThis.g_oIoMgr.Start()


const { CConfigDb2 } = require( '/usr/local/lib/rpcf/jslib/combase/configdb' );
const { messageType } = require( '/usr/local/lib/rpcf/jslib/dbusmsg/constants' );
const { ERROR, Int32Value, USER_METHOD } = require( '/usr/local/lib/rpcf/jslib/combase/defines' );
const {EnumClsid, errno, EnumPropId, EnumCallFlags, EnumTypeId, EnumSeriProto} = require( '/usr/local/lib/rpcf/jslib/combase/enums' );
const {CSerialBase, Variant} = require( '/usr/local/lib/rpcf/jslib/combase/seribase' );
const {CFastRpcProxy} = require( '/usr/local/lib/rpcf/jslib/ipc/fastrpc' )
const {Buffer} = require( 'buffer' );
const { DBusIfName, DBusDestination2, DBusObjPath } = require( '/usr/local/lib/rpcf/jslib/rpc/dmsg' );
const { KeyValue, } = require( './appmonstructs' );
// Start the client(s)
const { CAppMonitor_CliImpl } = require( './AppMonitorcli' )

var oAppMonitor_cli = null;

 // start the client object
function StartPullInfo()
{
    if( globalThis.curSpModal && globalThis.oProxy && globalThis.fetchAppDetails )
    {
        return globalThis.fetchAppDetails().then( (ret)=>{
            console.log( 'fetchAppDetails is done with status ' + ret );
        }).catch((e)=>{
            console.log( 'fetchAppDetails failed with error ' + e );
            return Promise.reject( e );
        });
    }
    return new Promise( ( resolve, reject )=>{
        var oContext = new Object();
        oContext.m_oResolve = resolve;
        oContext.m_oReject = reject;
        oContext.oListAppCb = (oContext, ret, arrApps ) => {
            if( ERROR( ret ) )
                return

            globalThis.g_sites[0].apps = []
            for ( var i = 0; i < arrApps.length; i++ )
            {
                if( this.m_setAppBaseLine.has( arrApps[i] ) )
                    continue
                globalThis.g_sites[0].apps.push(
                    { name: arrApps[i], status: globalThis.i18nHelper.t("APP_STATUS_UNKNOWN"), cpu: "0%" } )
            }
            if( this.m_strRouterPath === "/")
                globalThis.g_sites[0].name = globalThis.i18nHelper.t("Root Node");
            else
                globalThis.g_sites[0].name = this.m_strRouterPath
        }
        oContext.oListAppCb.bind( this )

        return this.ListApps( oContext ).then((ret)=>{
            Promise.resolve( ret );
        }).catch((e)=>{
            console.log( 'ListApps failed with error ' + e );
            Promise.reject( e );
        });
    }).then(( oContext)=>{
        console.log( 'request ListApps is done with status ' + oContext.m_iRet );
        appsAvail=[]

        for( var i = 0; i < globalThis.g_sites[0].apps.length; i++ )
            appsAvail.push( globalThis.g_sites[0].apps[i].name );

        oContext.oIsAppOnlineCb = (oContext, ret, arrOnlineApps ) => {
            if( ERROR( ret ) )
            {
                console.log( 'IsAppOnline returned with error from server: ' + Int32Value(ret) );
                return
            }

            for( var j = 0; j < globalThis.g_sites[0].apps.length; j++ )
                globalThis.g_sites[0].apps[j].status = i18nHelper.t("APP_STATUS_STOPPED");

            for ( var i = 0; i < arrOnlineApps.length; i++ )
            {
                if( this.m_setAppBaseLine.has( arrOnlineApps[i] ) )
                    continue
                for( var j = 0; j < globalThis.g_sites[0].apps.length; j++ )
                {
                    if( globalThis.g_sites[0].apps[j].name === arrOnlineApps[i] )
                    {
                        globalThis.g_sites[0].apps[j].status = i18nHelper.t("APP_STATUS_RUNNING");
                        break
                    }
                }
            }
            return
        }
        oContext.oIsAppOnlineCb.bind( oAppMonitor_cli )

        return oAppMonitor_cli.IsAppOnline( oContext, appsAvail ).then((ret)=>{
            var arrPtPaths = []
            console.log( 'request IsAppOnline is done with status ' + ret );
            for( var i = 0; i < globalThis.g_sites[0].apps.length; i++ )
            {
                if( globalThis.g_sites[0].apps[i].status === i18nHelper.t("APP_STATUS_RUNNING") )
                {
                    arrPtPaths.push( globalThis.g_sites[0].apps[i].name + "/cpu_load");
                    arrPtPaths.push( globalThis.g_sites[0].apps[i].name + "/app_class");
                }
            }
            oContext.oGetPvsCb = (oContext, ret, arrKeyVals ) => {
                if( ERROR(ret) ) 
                {
                    console.log( 'GetPointValues returned with error from server: ' + Int32Value(ret) );
                    return Promise.reject( ret );
                }
                for( var i = 0; i < arrKeyVals.length; i++ )
                {
                    var [strApp, strPt] = arrKeyVals[i].strKey.split( '/' );
                    for( var j = 0; j < globalThis.g_sites[0].apps.length; j++ )
                    {
                        if( globalThis.g_sites[0].apps[j].name === strApp )
                        {
                            if( strPt === "cpu_load" )
                                globalThis.g_sites[0].apps[j].cpu = arrKeyVals[i].oValue.m_val.toFixed(3) + "%";
                            else if( strPt === "app_class" )
                                globalThis.g_sites[0].apps[j].app_class = arrKeyVals[i].oValue.m_val
                            break;
                        }
                    }

                }
            }
            return oAppMonitor_cli.GetPointValues( oContext, "none", arrPtPaths ).then((ret)=>{
                console.log( 'request GetPointValues is done with status ' + ret );
                if( !globalThis.oProxy )
                    globalThis.oProxy = oAppMonitor_cli;

            }).catch((e)=>{
                console.log( 'GetPointValues failed with error ' + e );
                Promise.reject( e );
            })
        }).catch((e)=>{
            console.log( 'IsAppOnline failed with error ' + e );
            Promise.reject( e );
        })
    }).catch((e)=>{
        console.log( 'ListApps failed with error ' + e );
        return Promise.resolve(-errno.EFAULT);
    })
}

function StartClient( oStartCb )
{
    globalThis.g_strLoginResult = ""
    var strObjDesc = './appmondesc.json';
    var strAppMonitorObjName = 'AppMonitor';
    var oParams0 = globalThis.CoCreateInstance( EnumClsid.CConfigDb2 );
    oParams0.SetString( EnumPropId.propObjInstName, 'AppMonitor' );
    oAppMonitor_cli = new CAppMonitor_CliImpl( globalThis.g_oIoMgr,
        strObjDesc, strAppMonitorObjName, oParams0 );

    return oAppMonitor_cli.Start().then((retval)=>{
        if( ERROR( retval ) )
        {
            globalThis.oProxy = null;
            return Promise.resolve( retval );
        }
        var oContext = new Object();
        oContext.oStartCb = oStartCb
        globalThis.oProxy = undefined
        globalThis.funcStartPullInfo = StartPullInfo.bind( oAppMonitor_cli )
        return globalThis.funcStartPullInfo().then((ret)=>{
            if( oContext.oStartCb )
                oContext.oStartCb( oContext, ret );
            return Promise.resolve( ret );
        }
        ).catch((e)=>{
            if( oContext.oStartCb )
                oContext.oStartCb( oContext, -errno.EFAULT );
            console.log( 'StartPullInfo failed with error ' + e );
            return Promise.resolve(e);
        });
    }).catch((e)=>{
        console.log( 'Start Proxy failed with error ' + e );
        return Promise.resolve(e);
    })
}
globalThis.StartClient = StartClient;

function NewCfgDb()
{
    return new CConfigDb2();
}

function AllocBuffer( size )
{
    return Buffer.alloc( size );
}

function ConcatBuffer( buf1, buf2 )
{
    return Buffer.concat( [buf1, buf2] );
}
globalThis.ConcatBuffer = ConcatBuffer;
globalThis.AllocBuffer = AllocBuffer;
globalThis.NewCfgDb = NewCfgDb;
